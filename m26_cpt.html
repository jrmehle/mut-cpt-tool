<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MUT Tool</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèà</text></svg>">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cleave.js/1.6.0/cleave.min.js"></script>
<style>
  body {
    background: #000;
    background: linear-gradient(180deg, rgba(0, 0, 0, 1) 0%, var(--team-primary) 35%, rgba(0, 0, 0, 1) 100%);
    background-attachment: fixed;
    color: #e0e0e0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 1.5rem;
    min-height: 100vh;
    transition: background 0.5s ease;
  }

  dialog {
    border: none;
    border-radius: 8px;
    padding: 0;
    max-width: 400px;
    background: linear-gradient(135deg, rgba(var(--team-primary-rgb), 1) 0%, rgba(20, 20, 30, 1) 100%);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(10px);
    border: 2px solid var(--team-secondary);
  }

  dialog::backdrop {
    background: rgba(0, 0, 0, 0.75);
    backdrop-filter: blur(4px);
  }

  .dialog-content {
    padding: 1.5rem;
  }

  .dialog-content form {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  #dialogMessage {
    margin: 0;
    font-size: 1rem;
    color: #e0e0e0;
    line-height: 1.5;
    text-align: center;
  }

  .dialog-buttons {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
  }

  .dialog-buttons button {
    padding: 0.25rem 1.0rem;
    border: 2px solid;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 90px;
  }

  .dialog-buttons button[value="cancel"] {
    background: rgba(65, 65, 65, 0.8);
    border-color: #888;
    color: #e0e0e0;
  }

  .dialog-buttons button[value="cancel"]:hover {
    border-color: #444;
  }

  .dialog-buttons button[value="confirm"] {
    background: var(--team-primary);
    border-color: var(--team-secondary);
    color: var(--team-secondary);
  }

  .dialog-buttons button[value="confirm"]:hover {
    background: rgba(var(--team-primary-rgb), 0.6);
    border-color: #444;
    color: #888;
  }

  .fs-7 {
    font-size: 0.7rem !important;
  }

  .fs-8 {
    font-size: 0.6rem !important;
  }

  .team-selector {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 1000;
  }

  .team-selector select {
    background-color: rgba(20, 20, 30, 1);
    color: #fff;
    border: 2px solid var(--team-primary);
    border-radius: 8px;
    padding: 0.5rem 1rem;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .team-selector select:hover {
    border-color: var(--team-secondary);
    box-shadow: 0 0 10px var(--team-primary);
  }

  :root {
    --team-primary: #707070;
    --team-secondary: #D3D3D3;
  }

  .nav-tabs {
    border-color: #414141;
  }

  .nav-link {
    background-color: rgba(var(--team-primary-rgb), 0.5) !important;
    border-color: #414141 !important;
    color: var(--team-primary-light);
    text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.1);
    font-weight: 700;
  }

  .nav-link:hover, .nav-link:focus {
    color: #FFF;
  }

  .nav-link.active {
    color: var(--team-accent) !important;
    /*background-color: var(--team-accent) !important;*/
    border-color: var(--team-primary-light) !important;
    transition: all 0.3s ease;
  }

  .header-section {
    background: rgba(var(--team-primary-rgb), 0.4);
    border: 2px solid #414141;
    border-radius: 8px;
    padding: 0.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
  }

  .control-group {
    display: flex;
    gap: 0.75rem;
    align-items: end;
    flex-wrap: wrap;
  }

  .player-card {
    background: linear-gradient(135deg, rgba(var(--team-primary-rgb), 0.3) 0%, rgba(20, 20, 30, 0.98) 100%);
    border: 2px solid #414141;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    padding: 0.75rem 0.5rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
  }

  .player-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--team-primary), var(--team-secondary));
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .player-card:hover {
    transform: translateY(-2px);
    border-color: var(--team-secondary);
    box-shadow: 0 6px 20px rgba(var(--team-secondary-rgb), 0.3);
  }

  .player-card:hover::before {
    opacity: 1;
  }

  .player-card.dim {
    opacity: 0.3;
    pointer-events: none;
  }

  .player-card.best-value {
    border: 2px solid var(--team-secondary);
    background: linear-gradient(135deg, rgba(var(--team-primary-rgb), 0.6) 0%, rgba(20, 20, 30, 0.95) 100%);
    box-shadow: 0 6px 24px rgba(var(--team-secondary-rgb), 0.4);
  }

  .player-card.best-value::before {
    background: linear-gradient(90deg, var(--team-secondary), var(--team-accent, var(--team-secondary)));
    opacity: 1;
  }

  .player-card.best-value .ovr-badge {
    border-color: var(--team-secondary);
  }

  .ovr-badge {
    display: inline-block;
    background: linear-gradient(135deg, var(--team-primary), var(--team-primary-light, var(--team-primary)));
    color: var(--team-secondary);
    padding: 0.25rem 0.75rem;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
    letter-spacing: 0.3px;
    min-width: 32px;
    text-align: center;
    box-shadow: 0 3px 10px rgba(var(--team-primary-rgb), 0.5);
    border: 2px solid var(--team-primary-light);
    border-radius: 8px;
    transition: all 0.3s ease;
  }

    /* Chrome, Safari, Edge, Opera */
  .ovr-badge input[type="number"]::-webkit-inner-spin-button,
  .ovr-badge input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  /* Firefox */
  .ovr-badge input[type="number"] {
    -moz-appearance: textfield;
    appearance: textfield;
  }

  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
  }

  .card-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.25rem;
    margin-top: 0.25rem;
  }

  .stat-item {
    background: rgba(var(--team-primary-rgb), 0.5);
    border: 1px solid var(--team-primary-light);
    border-radius: 6px;
    padding: 0.5rem 0.25rem;
    /* This is the key for horizontal alignment */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    min-height: 42px; /* Ensures all boxes are the same height */
  }

  .stat-label {
    font-size: 0.55rem;
    color: #aaa;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    line-height: 1.2;
    text-align: center;
    width: 100%;
    margin-bottom: 0.25rem;
  }

  .stat-value {
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--team-secondary);
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
    text-align: center;
    width: 100%;
    white-space: nowrap;
  }

  .input-field {
    background: rgba(20, 20, 30, 0.6);
    color: #e8e8e8;
    border: 2px solid rgba(var(--team-secondary-rgb), 0.15);
    border-radius: 8px;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    transition: all 0.2s ease;
  }

  .input-field:focus {
    background-color: rgba(30, 30, 40, 0.9);
    color: #fff;
    border-color: var(--team-secondary);
    box-shadow: 0 0 0 0.15rem rgba(var(--team-secondary-rgb), 0.25);
    outline: none;
  }

  .input-field::placeholder {
    color: #c0c0c0;
  }

  .form-label {
    color: #c0c0c0;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
  }

  .best-value-banner {
    position: absolute;
    top: -2px;
    right: -2px;
    background: linear-gradient(135deg, var(--team-secondary), var(--team-accent, var(--team-secondary)));
    padding: 0.4rem 0.6rem;
    font-weight: 800;
    font-size: 0.6rem;
    display: none;
    z-index: 10;
    box-shadow: -2px 2px 8px rgba(0, 0, 0, 0.4);
    text-shadow: 1px 1px 1px rgba(128, 0, 0, 1);
    letter-spacing: 0.5px;
    transform: rotate(0deg);
    border-bottom-left-radius: 6px;
    border-top-right-radius: 6px;
  }

  .player-card.best-value .best-value-banner {
    display: block;
  }

  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #888;
  }

  .empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }

  @media (max-width: 768px) {
    .cards-grid {
      grid-template-columns: 1fr;
    }
  }

  .training-value {
    font-size: 0.7rem;
    color: #aaa;
  }

  .platinum-qs {
    font-size: 0.65rem;
    color: #aaa;
    font-style: italic;
  }

  .promo-ovr-input {
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
  }

  #addPromoRow {
    background: #c0c0c0;
    border-color: var(--team-primary);
  }

  #addPromoRow:hover {
    color: #333;
    background: #888;
  }

  #addPromoRow, .delete-promo {
    color: #000;
  }

  #resetBtn, #addPromoRow, #clearPromo, .delete-promo {
    padding: 0.25rem 0.5rem !important;
    font-size: 0.75rem;
    border-color: rgba(var(--team-primary-rgb), 0.7);
  }

  #addPromoRow:hover, #clearPromo:hover {
    border-color: rgba(var(--team-primary-rgb), 0.9);
  }

  #resetBtn, #addPromoRow, #clearPromo, .delete-promo {
    border-width: 2px;
  }

  #resetBtn:hover, #addPromoRow:hover, #clearPromo:hover, .delete-promo:hover {
    color: #333;
  }
</style>
</head>
<body>
  <div class="team-selector">
    <select id="teamSelect" class="form-select">
      <option value="">Select Team Color Theme</option>
      <option value="vikings">Minnesota Vikings</option>
      <option value="packers">Green Bay Packers</option>
      <option value="bears">Chicago Bears</option>
      <option value="lions">Detroit Lions</option>
      <option value="cowboys">Dallas Cowboys</option>
      <option value="eagles">Philadelphia Eagles</option>
      <option value="giants">New York Giants</option>
      <option value="commanders">Washington Commanders</option>
      <option value="49ers">San Francisco 49ers</option>
      <option value="seahawks">Seattle Seahawks</option>
      <option value="rams">Los Angeles Rams</option>
      <option value="cardinals">Arizona Cardinals</option>
      <option value="buccaneers">Tampa Bay Buccaneers</option>
      <option value="saints">New Orleans Saints</option>
      <option value="panthers">Carolina Panthers</option>
      <option value="falcons">Atlanta Falcons</option>
      <option value="chiefs">Kansas City Chiefs</option>
      <option value="raiders">Las Vegas Raiders</option>
      <option value="chargers">Los Angeles Chargers</option>
      <option value="broncos">Denver Broncos</option>
      <option value="bills">Buffalo Bills</option>
      <option value="dolphins">Miami Dolphins</option>
      <option value="patriots">New England Patriots</option>
      <option value="jets">New York Jets</option>
      <option value="steelers">Pittsburgh Steelers</option>
      <option value="ravens">Baltimore Ravens</option>
      <option value="browns">Cleveland Browns</option>
      <option value="bengals">Cincinnati Bengals</option>
      <option value="colts">Indianapolis Colts</option>
      <option value="texans">Houston Texans</option>
      <option value="titans">Tennessee Titans</option>
      <option value="jaguars">Jacksonville Jaguars</option>
    </select>
  </div>

  <div class="container">
    <h2 class="mb-4">üèà MUT Tools</h2>

    <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="training-tab" data-bs-toggle="tab"
                data-bs-target="#trainingPane" type="button" role="tab">
          Coin / Training
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="promo-tab" data-bs-toggle="tab"
                data-bs-target="#promoPane" type="button" role="tab">
          Current Promo
        </button>
      </li>
    </ul>

    <div class="tab-content" id="mainTabsContent">

      <div class="tab-pane fade show active" id="trainingPane" role="tabpanel">
        <div class="header-section">
          <div class="control-group">
            <div>
              <label for="currentCPT" class="form-label">Coin/Training Rate</label>
              <input id="currentCPT" type="text" class="form-control input-field"
                     placeholder="e.g., 3.5" style="width: 146px;">
            </div>
            <div>
              <label for="currentLTD" class="form-label">LTD OVR Threshold</label>
              <input id="currentLTD" type="number" class="form-control input-field"
                     placeholder="e.g., 90" style="width: 144px;">
            </div>
            <button id="resetBtn" class="btn btn-warning py-1">Reset All</button>
          </div>
        </div>

        <div id="playerCards" class="cards-grid"></div>
      </div>

      <div class="tab-pane fade" id="promoPane" role="tabpanel">
        <div class="header-section">
          <div class="control-group">
            <div>
              <label for="promoCurrencyName" class="form-label mb-0">Promo Currency</label>
              <input id="promoCurrencyName" type="text" class="form-control input-field"
                     placeholder="e.g., Tokens" style="width: 130px;">
            </div>
            <button id="addPromoRow" class="btn">Add OVR</button>
            <button id="clearPromo" class="btn btn-warning">Clear All</button>
          </div>
        </div>

        <div id="promoCards" class="cards-grid"></div>
        <div id="promoEmpty" class="empty-state" style="display: none;">
          <div class="empty-state-icon">üì¶</div>
          <p>No promo players yet. Click "Add OVR" to get started!</p>
        </div>
      </div>

    </div>
  </div>

  <dialog id="confirmDialog">
    <div class="dialog-content">
      <form method="dialog">
        <p id="dialogMessage"></p>
        <div class="dialog-buttons">
          <button value="cancel" type="submit">Cancel</button>
          <button value="confirm" type="submit">OK</button>
        </div>
      </form>
    </div>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  'use strict';

  const STORAGE_KEYS = {
    MUT_STATE: 'mutState',
    PROMO_DATA: 'promoData',
    PROMO_NAME: 'promoCurrencyName',
    TEAM: 'selectedTeam',
    ACTIVE_TAB: 'activeTab'
  };

  const NFL_TEAMS = {
    '': { primary: '#505050', secondary: '#D3D3D3', accent: '#FFFFFF', name: 'Default' },
    vikings: { primary: '#4F2683', secondary: '#FFC62F', accent: '#FFD700', name: 'Minnesota Vikings' },
    packers: { primary: '#203731', secondary: '#FFB612', accent: '#FFD700', name: 'Green Bay Packers' },
    bears: { primary: '#0B162A', secondary: '#C83803', accent: '#DD4814', name: 'Chicago Bears' },
    lions: { primary: '#0076B6', secondary: '#B0B7BC', accent: '#FFFFFF', name: 'Detroit Lions' },
    cowboys: { primary: '#041E42', secondary: '#869397', accent: '#FFFFFF', name: 'Dallas Cowboys' },
    eagles: { primary: '#004C54', secondary: '#A5ACAF', accent: '#ACC0C6', name: 'Philadelphia Eagles' },
    giants: { primary: '#0B2265', secondary: '#A71930', accent: '#A5ACAF', name: 'New York Giants' },
    commanders: { primary: '#5A1414', secondary: '#FFB612', accent: '#FFD700', name: 'Washington Commanders' },
    '49ers': { primary: '#AA0000', secondary: '#B3995D', accent: '#FFD700', name: 'San Francisco 49ers' },
    seahawks: { primary: '#002244', secondary: '#69BE28', accent: '#A5ACAF', name: 'Seattle Seahawks' },
    rams: { primary: '#003594', secondary: '#FFA300', accent: '#FFD700', name: 'Los Angeles Rams' },
    cardinals: { primary: '#97233F', secondary: '#FFB612', accent: '#FFD700', name: 'Arizona Cardinals' },
    buccaneers: { primary: '#D50A0A', secondary: '#FF7900', accent: '#34302B', name: 'Tampa Bay Buccaneers' },
    saints: { primary: '#101820', secondary: '#D3BC8D', accent: '#9F8958', name: 'New Orleans Saints' },
    panthers: { primary: '#101820', secondary: '#0085CA', accent: '#BFC0BF', name: 'Carolina Panthers' },
    falcons: { primary: '#000000', secondary: '#A71930', accent: '#A5ACAF', name: 'Atlanta Falcons' },
    chiefs: { primary: '#E31837', secondary: '#FFB81C', accent: '#FFD700', name: 'Kansas City Chiefs' },
    raiders: { primary: '#000000', secondary: '#A5ACAF', accent: '#FFFFFF', name: 'Las Vegas Raiders' },
    chargers: { primary: '#0080C6', secondary: '#FFC20E', accent: '#FFD700', name: 'Los Angeles Chargers' },
    broncos: { primary: '#002244', secondary: '#FB4F14', accent: '#FFB612', name: 'Denver Broncos' },
    bills: { primary: '#00338D', secondary: '#C60C30', accent: '#A5ACAF', name: 'Buffalo Bills' },
    dolphins: { primary: '#008E97', secondary: '#FC4C02', accent: '#005778', name: 'Miami Dolphins' },
    patriots: { primary: '#002244', secondary: '#C60C30', accent: '#B0B7BC', name: 'New England Patriots' },
    jets: { primary: '#125740', secondary: '#FFFFFF', accent: '#000000', name: 'New York Jets' },
    steelers: { primary: '#101820', secondary: '#FFB612', accent: '#A5ACAF', name: 'Pittsburgh Steelers' },
    ravens: { primary: '#241773', secondary: '#9E7C0C', accent: '#000000', name: 'Baltimore Ravens' },
    browns: { primary: '#311D00', secondary: '#FF3C00', accent: '#FFB612', name: 'Cleveland Browns' },
    bengals: { primary: '#000000', secondary: '#FB4F14', accent: '#FFFFFF', name: 'Cincinnati Bengals' },
    colts: { primary: '#002C5F', secondary: '#A2AAAD', accent: '#FFFFFF', name: 'Indianapolis Colts' },
    texans: { primary: '#03202F', secondary: '#A71930', accent: '#FFFFFF', name: 'Houston Texans' },
    titans: { primary: '#0C2340', secondary: '#4B92DB', accent: '#C8102E', name: 'Tennessee Titans' },
    jaguars: { primary: '#006778', secondary: '#D7A22A', accent: '#9F792C', name: 'Jacksonville Jaguars' }
  };

  const TAX_RATE = 0.9;
  const MIN_PROFIT = 1000;

  const PLAYER_DATA = [
    { ovr: 80, training: 110, platinumQS: '14,000' },
    { ovr: 81, training: 170, platinumQS: '23,000' },
    { ovr: 82, training: 270, platinumQS: '36,000' },
    { ovr: 83, training: 430, platinumQS: '57,000' },
    { ovr: 84, training: 680, platinumQS: '90,000' },
    { ovr: 85, training: 1080, platinumQS: '143,000' },
    { ovr: 86, training: 1700, platinumQS: '225,000' },
    { ovr: 87, training: 2700, platinumQS: '-' },
    { ovr: 88, training: 4200, platinumQS: '-' },
    { ovr: 89, training: 6700, platinumQS: '-' },
    { ovr: 90, training: 10600, platinumQS: '-' },
    { ovr: 91, training: 16700, platinumQS: '-' },
    { ovr: 92, training: 26000, platinumQS: '-' },
    { ovr: 93, training: 42000, platinumQS: '-' },
    { ovr: 94, training: 66000, platinumQS: '-' },
    { ovr: 95, training: 100000, platinumQS: '-' },
    { ovr: 96, training: 160000, platinumQS: '-' },
    { ovr: 97, training: 260000, platinumQS: '-' },
    { ovr: 98, training: 410000, platinumQS: '-' },
    { ovr: 99, training: 650000, platinumQS: '-' }
  ];

  const Utils = {
    parseNumber(str) {
      const cleaned = String(str).replace(/,/g, '');
      const parsed = parseFloat(cleaned);
      return isNaN(parsed) ? 0 : parsed;
    },

    formatNumber(num, decimals = 0) {
      return num.toLocaleString('en-US', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    },

    safeGetItem(key) {
      try {
        return localStorage.getItem(key);
      } catch (e) {
        return null;
      }
    },

    safeSetItem(key, value) {
      try {
        localStorage.setItem(key, value);
      } catch (e) {
        console.warn('localStorage unavailable');
      }
    },

    safeClearStorage() {
      try {
        localStorage.clear();
      } catch (e) {
        console.warn('localStorage unavailable');
      }
    },

    hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ?
        `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` :
        '79, 38, 131';
    },

    setTeamColors(teamKey) {
      const team = NFL_TEAMS[teamKey];
      if (!team) return;

      const root = document.documentElement;
      root.style.setProperty('--team-primary', team.primary);
      root.style.setProperty('--team-secondary', team.secondary);
      root.style.setProperty('--team-accent', team.accent);
      root.style.setProperty('--team-primary-rgb', this.hexToRgb(team.primary));
      root.style.setProperty('--team-secondary-rgb', this.hexToRgb(team.secondary));

      // Lighter version of primary for gradients
      const primaryRgb = this.hexToRgb(team.primary);
      const [r, g, b] = primaryRgb.split(', ').map(n => Math.min(255, parseInt(n) + 40));
      root.style.setProperty('--team-primary-light', `rgb(${r}, ${g}, ${b})`);

      Utils.safeSetItem(STORAGE_KEYS.TEAM, teamKey);
    },

    confirmDialog(message, options = {}) {
      return new Promise((resolve) => {
        const dialog = document.getElementById('confirmDialog');
        const messageEl = document.getElementById('dialogMessage');
        const cancelBtn = dialog.querySelector('button[value="cancel"]');
        const confirmBtn = dialog.querySelector('button[value="confirm"]');

        messageEl.textContent = message;
        cancelBtn.textContent = options.cancelText || 'Cancel';
        confirmBtn.textContent = options.confirmText || 'OK';

        dialog.showModal();

        dialog.addEventListener('close', () => {
          resolve(dialog.returnValue === 'confirm');
        }, { once: true });
      });
    }
  };

  const TrainingTab = (() => {
    const elements = {
      cptInput: document.getElementById('currentCPT'),
      ltdInput: document.getElementById('currentLTD'),
      resetBtn: document.getElementById('resetBtn'),
      container: document.getElementById('playerCards')
    };

    let playerCards = [];

    function init() {
      new Cleave(elements.cptInput, {
        numeral: true,
        numeralThousandsGroupStyle: 'thousand',
        numeralDecimalMark: '.',
        delimiter: ','
      });

      loadState();
      renderCards();
      setupEventListeners();
    }

    function setupEventListeners() {
      elements.cptInput.addEventListener('input', handleUpdate);
      elements.ltdInput.addEventListener('input', handleUpdate);
      elements.resetBtn.addEventListener('click', handleReset);
    }

    function handleUpdate() {
      recalculate();
      saveState();
    }

    async function handleReset() {
      if (!await Utils.confirmDialog('Clear all Coin/Training data?')) return;

      Utils.safeClearStorage();
      elements.cptInput.value = '';
      elements.ltdInput.value = '';
      playerCards.forEach(card => {
        card.input.value = '';
      });
      recalculate();
    }

    function renderCards() {
      elements.container.innerHTML = '';

      PLAYER_DATA.forEach(data => {
        const card = document.createElement('div');
        card.className = 'player-card';
        card.dataset.ovr = data.ovr;

        const platinumQSHtml = data.platinumQS !== '-'
          ? `<div class="platinum-qs">Platinum QS: ${data.platinumQS}</div>`
          : '<div style="height: 0.975rem;"></div>';

        card.innerHTML = `
          <div class="best-value-banner" title="Best Value!">üî•</div>
          <div class="d-flex justify-content-between align-items-start">
            <div class="col">
              <div class="ovr-badge fw-bold fs-4">${data.ovr}</div>
            </div>
            <div class="col" style="margin-top: -0.6rem;">
              <label class="form-label mb-1 fs-8">Avg Price</label>
              <input type="text" class="form-control input-field avg-price-input" placeholder="Price">
            </div>
          </div>
          <div class="mt-1">
            <div class="training-value">${Utils.formatNumber(data.training)} TP</div>
            ${platinumQSHtml}
          </div>
          <div class="card-stats">
            <div class="stat-item">
              <div class="stat-label text-center text-nowrap">C/T</div>
              <div class="stat-value coin-per-training text-center">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label text-center text-nowrap">Mkt Rate</div>
              <div class="stat-value price-at-cpt text-center">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label text-center text-nowrap">Target</div>
              <div class="stat-value target-price text-center">-</div>
            </div>
          </div>
        `;

        const input = card.querySelector('.avg-price-input');
        new Cleave(input, {
          numeral: true,
          numeralThousandsGroupStyle: 'thousand',
          numeralDecimalMark: '.',
          delimiter: ','
        });

        input.addEventListener('input', () => {
          recalculate();
          saveState();
        });

        elements.container.appendChild(card);
        playerCards.push({
          element: card,
          input: input,
          data: data,
          coinPerTraining: card.querySelector('.coin-per-training'),
          priceAtCpt: card.querySelector('.price-at-cpt'),
          targetPrice: card.querySelector('.target-price')
        });
      });
    }

    function recalculate() {
      const cpt = Utils.parseNumber(elements.cptInput.value);
      const ltd = parseInt(elements.ltdInput.value) || 0;
      let minCPT = Infinity;
      let bestCard = null;

      playerCards.forEach(card => {
        const avg = Utils.parseNumber(card.input.value);
        const isDimmed = ltd > 0 && card.data.ovr >= ltd;

        card.element.classList.toggle('dim', isDimmed);

        if (!avg) {
          card.coinPerTraining.textContent = '-';
          card.priceAtCpt.textContent = '-';
          card.targetPrice.textContent = '-';
          card.element.classList.remove('best-value');
          return;
        }

        const coinPerTraining = avg / card.data.training;
        const priceAtCPT = card.data.training * cpt;
        const targetPrice = (avg * TAX_RATE) - MIN_PROFIT;

        card.coinPerTraining.textContent = coinPerTraining.toFixed(1);
        card.priceAtCpt.textContent = cpt ? Utils.formatNumber(Math.round(priceAtCPT)) : '-';
        card.targetPrice.textContent = Utils.formatNumber(Math.round(targetPrice));

        if (cpt && coinPerTraining < minCPT && !isDimmed) {
          minCPT = coinPerTraining;
          bestCard = card;
        }
      });

      playerCards.forEach(card => {
        card.element.classList.remove('best-value');
        card.coinPerTraining.classList.remove('highlight');
      });

      if (bestCard) {
        bestCard.element.classList.add('best-value');
        bestCard.coinPerTraining.classList.add('highlight');
      }
    }

    function saveState() {
      const state = {
        cpt: elements.cptInput.value,
        ltd: elements.ltdInput.value,
        avgs: playerCards.map(card => card.input.value)
      };
      Utils.safeSetItem(STORAGE_KEYS.MUT_STATE, JSON.stringify(state));
    }

    function loadState() {
      const saved = Utils.safeGetItem(STORAGE_KEYS.MUT_STATE);
      if (!saved) return;

      try {
        const state = JSON.parse(saved);
        if (state.cpt) elements.cptInput.value = state.cpt;
        if (state.ltd) elements.ltdInput.value = state.ltd;
        if (state.avgs?.length) {
          setTimeout(() => {
            playerCards.forEach((card, i) => {
              if (state.avgs[i]) card.input.value = state.avgs[i];
            });
            recalculate();
          }, 0);
        }
      } catch (e) {
        console.error('Failed to load state:', e);
      }
    }

    return { init };
  })();

  const PromoTab = (() => {
    const elements = {
      nameInput: document.getElementById('promoCurrencyName'),
      container: document.getElementById('promoCards'),
      emptyState: document.getElementById('promoEmpty'),
      addBtn: document.getElementById('addPromoRow'),
      clearBtn: document.getElementById('clearPromo')
    };

    let promoCards = [];
    let currencyName = '';

    function init() {
      loadData();
      setupEventListeners();
      updateEmptyState();
      handleNameChange();
    }

    function setupEventListeners() {
      elements.nameInput.addEventListener('input', handleNameChange);
      elements.addBtn.addEventListener('click', () => addCard());
      elements.clearBtn.addEventListener('click', handleClear);
    }

    function handleNameChange() {
      currencyName = elements.nameInput.value.trim();
      Utils.safeSetItem(STORAGE_KEYS.PROMO_NAME, currencyName);
      const displayName = currencyName || 'Promo Currency';

      promoCards.forEach(cardObj => {
        const qsLabel = cardObj.card.querySelector('.currency-qs-label');
        const coinLabel = cardObj.card.querySelector('.currency-coin-label');
        if (qsLabel) {
          qsLabel.textContent = `${displayName} QS`;
        }
        if (coinLabel) {
          coinLabel.textContent = `${displayName}/Coin`;
        }
      });
    }

    async function handleClear() {
      if (!await Utils.confirmDialog('Clear all promo data?')) return;
      promoCards = [];
      elements.container.innerHTML = '';
      elements.nameInput.value = '';
      currencyName = '';
      Utils.safeSetItem(STORAGE_KEYS.PROMO_NAME, '');
      saveData();
      updateEmptyState();
    }

    function loadData() {
      const savedData = Utils.safeGetItem(STORAGE_KEYS.PROMO_DATA);
      const savedName = Utils.safeGetItem(STORAGE_KEYS.PROMO_NAME);

      if (savedData) {
        try {
          const data = JSON.parse(savedData);
          data.forEach(item => addCard(item));
        } catch (e) {
          console.error('Failed to parse promo data:', e);
        }
      }

      if (savedName) {
        currencyName = savedName;
        elements.nameInput.value = currencyName;
      }
    }

    function addCard(existingData = null) {
      const card = document.createElement('div');
      card.className = 'player-card';

      const displayName = currencyName || 'Promo Currency';

      card.innerHTML = `
        <div class="best-value-banner" title="Best Value!">üî•</div>
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div class="col">
            <div class="ovr-badge">
              <input type="number" class="promo-ovr-input text-center fw-bold fs-4" placeholder="OVR"
                     style="background: transparent; border: none; color: inherit; width: 32px; padding: 0;">
            </div>
          </div>
          <div class="col" style="margin-top: -0.6rem;">
            <label class="form-label mb-1 fs-8">Avg Price</label>
            <input type="text" class="form-control input-field promo-avg-input" placeholder="Price">
          </div>
        </div>
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div class="col">
            <div class="training-value">
              <input type="text" class="form-control input-field promo-qs-input mt-1 px-0.5 py-1" placeholder="QS Value">
            </div>
            <div class="platinum-qs currency-qs-label">${displayName} QS</div>
          </div>
          <div class="col">
            <button class="btn btn-danger mt-1 w-100 delete-promo">Remove</button>
          </div>
        </div>
        <div class="card-stats">
          <div class="stat-item">
            <div class="stat-label text-center currency-coin-label text-wrap">${displayName} / Coin</div>
            <div class="stat-value promo-cpc text-center">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label text-center">Target</div>
            <div class="stat-value promo-target text-center">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label text-center">Mkt Value</div>
            <div class="stat-value promo-card-cost text-center">-</div>
          </div>
        </div>
      `;

      elements.container.appendChild(card);

      const inputs = {
        ovr: card.querySelector('.promo-ovr-input'),
        qs: card.querySelector('.promo-qs-input'),
        avg: card.querySelector('.promo-avg-input')
      };

      new Cleave(inputs.qs, {
        numeral: true,
        numeralThousandsGroupStyle: 'thousand',
        numeralDecimalMark: '.',
        delimiter: ','
      });

      new Cleave(inputs.avg, {
        numeral: true,
        numeralThousandsGroupStyle: 'thousand',
        numeralDecimalMark: '.',
        delimiter: ','
      });

      if (existingData) {
        inputs.ovr.value = existingData.ovr;
        inputs.qs.value = existingData.qs;
        inputs.avg.value = existingData.avg;
      }

      const cardObj = {
        card: card,
        inputs: inputs,
        cpc: card.querySelector('.promo-cpc'),
        target: card.querySelector('.promo-target'),
        cardCost: card.querySelector('.promo-card-cost')
      };

      [inputs.ovr, inputs.qs, inputs.avg].forEach(input => {
        input.addEventListener('input', () => {
          recalculateAll();
          saveData();
        });
      });

      // remove button
      card.querySelector('.delete-promo').addEventListener('click', async () => {
        if (inputs.ovr.value != '' && !await Utils.confirmDialog(`Remove ${inputs.ovr.value} OVR?`)) return;
        card.remove();
        promoCards = promoCards.filter(c => c !== cardObj);
        recalculateAll();
        saveData();
        updateEmptyState();
      });

      promoCards.push(cardObj);
      recalculateAll();
      updateEmptyState();
    }

    function recalculateAll() {
      let minCPC = Infinity;
      let bestCard = null;

      promoCards.forEach(cardObj => {
        const qs = Utils.parseNumber(cardObj.inputs.qs.value);
        const avg = Utils.parseNumber(cardObj.inputs.avg.value);

        if (!avg || !qs) {
          cardObj.cpc.textContent = '-';
          cardObj.target.textContent = '-';
          cardObj.cardCost.textContent = '-';
          cardObj.card.classList.remove('best-value');
          return;
        }

        const coinPerCurrency = avg / qs;
        cardObj._tempRatio = coinPerCurrency; // Store for calculation

        if (coinPerCurrency < minCPC) {
          minCPC = coinPerCurrency;
          bestCard = cardObj;
        }
      });

      // Apply the best ratio to all cards to show the "Card Cost"
      promoCards.forEach(cardObj => {
        const qs = Utils.parseNumber(cardObj.inputs.qs.value);
        const avg = Utils.parseNumber(cardObj.inputs.avg.value);

        cardObj.card.classList.remove('best-value');
        cardObj.cpc.classList.remove('highlight');

        if (!avg || !qs) return;

        const coinAfterTax = avg * TAX_RATE;
        const targetPrice = coinAfterTax - MIN_PROFIT;

        cardObj.cpc.textContent = cardObj._tempRatio.toFixed(2);
        cardObj.target.textContent = Utils.formatNumber(Math.round(targetPrice));

        // Cost = How much currency THIS card is worth * THE BEST ratio found in the set
        if (minCPC !== Infinity) {
          const calculatedCost = qs * minCPC;
          cardObj.cardCost.textContent = Utils.formatNumber(Math.round(calculatedCost));
        } else {
          cardObj.cardCost.textContent = '-';
        }
      });

      // Highlight best value
      if (bestCard) {
        bestCard.card.classList.add('best-value');
        bestCard.cpc.classList.add('highlight');
      }
    }

    function saveData() {
      const data = promoCards.map(cardObj => ({
        ovr: cardObj.inputs.ovr.value,
        qs: cardObj.inputs.qs.value,
        avg: cardObj.inputs.avg.value
      }));
      Utils.safeSetItem(STORAGE_KEYS.PROMO_DATA, JSON.stringify(data));
    }

    function updateEmptyState() {
      elements.emptyState.style.display = promoCards.length === 0 ? 'block' : 'none';
    }

    return { init };
  })();

  document.addEventListener('DOMContentLoaded', () => {
    // Load saved team
    const savedTeam = Utils.safeGetItem(STORAGE_KEYS.TEAM);
    const teamSelect = document.getElementById('teamSelect');
    teamSelect.value = savedTeam;
    Utils.setTeamColors(savedTeam);

    // Team selector change handler
    teamSelect.addEventListener('change', (e) => {
      Utils.setTeamColors(e.target.value);
    });

    // Initialize tabs
    TrainingTab.init();
    PromoTab.init();

    // Restore active tab on load
    const savedTab = Utils.safeGetItem(STORAGE_KEYS.ACTIVE_TAB);

    if (savedTab) {
      const tabButton = document.querySelector(
        `#mainTabs button[data-bs-target="${savedTab}"]`
      );

      if (tabButton) {
        const tab = new bootstrap.Tab(tabButton);
        tab.show();
      }
    }

    // Persist tab changes
    const tabButtons = document.querySelectorAll(
      '#mainTabs button[data-bs-toggle="tab"]'
    );

    tabButtons.forEach(btn => {
      btn.addEventListener('shown.bs.tab', (e) => {
        const targetId = e.target.getAttribute('data-bs-target');
        Utils.safeSetItem(STORAGE_KEYS.ACTIVE_TAB, targetId);
      });
    });
  });
  </script>
</body>
</html>
